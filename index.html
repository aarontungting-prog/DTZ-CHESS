<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>éœ“è™¹è¥¿æ´‹æ£‹ï¼šæœ€çµ‚ä¿®å¾©ç‰ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script>
        window.onerror = function(msg, url, line) {
            const box = document.getElementById('error-box');
            if(box) {
                box.style.display = 'block';
                box.innerHTML += `âŒ ${msg} <br><small>${url}:${line}</small><hr>`;
            }
        }
    </script>
</head>
<body>

<div id="loading">ç³»çµ±è¼‰å…¥ä¸­...<br><small>(è‹¥å¡ä½è¶…é 5 ç§’è«‹æˆªåœ–)</small></div>

<div id="error-box" style="display:none; position:fixed; top:0; left:0; width:100%; height:auto; background:rgba(20,0,0,0.95); color:#ff5555; z-index:9999; padding:20px; font-size:12px; border-bottom:2px solid red;"></div>

<div id="auth-modal">
    <div class="auth-box">
        <h2>DTZ CHESS</h2>
        <div id="auth-error" style="color:#ff0055; font-size:12px; margin-bottom:10px;"></div>
        <div id="email-login-form">
            <input type="email" id="email" class="auth-input" placeholder="é›»å­ä¿¡ç®±">
            <input type="password" id="password" class="auth-input" placeholder="å¯†ç¢¼">
            <div id="nickname-container"><input type="text" id="nickname" class="auth-input" placeholder="è¨­å®šæš±ç¨±"></div>
            <button id="auth-action-btn" class="auth-btn">é€²å…¥ä¸–ç•Œ</button>
        </div>
        <button id="guest-btn" class="guest-btn">è¨ªå®¢ç™»å…¥</button>
    </div>
</div>

<div id="ui" style="display:none;">
    <div id="mobile-menu-btn" onclick="toggleMenu()">â˜° é¸å–®</div>
    <div id="menu-panel" class="hud-container">
        <div class="hud-box profile-box">
            <div class="user-card-header">
                <img id="hud-avatar" src="" class="mini-avatar">
                <div class="user-info"><span id="user-name" class="name-text">Player</span></div>
            </div>
            <button id="btn-custom" class="custom-btn">ğŸ› ï¸ è¨­å®š</button>
        </div>
        <div class="hud-box action-box">
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <button id="mode-2p" class="mode-btn active" onclick="switchMode('2p')">1v1</button>
                <button id="mode-4p" class="mode-btn" onclick="switchMode('4p')">4äºº</button>
            </div>
            <div id="room-display" class="room-status">ç‹€æ…‹ï¼šé–’ç½®ä¸­</div>
            <button id="btn-create" class="game-btn">å‰µå»ºæˆ¿é–“</button>
            <button id="btn-join" class="game-btn join-btn">åŠ å…¥æˆ¿é–“</button>
            <button id="btn-leave" class="game-btn" style="display:none; background:#0088ff;">é€€å‡º</button>
            <div class="separator"></div>
            <button id="btn-logout" class="logout-btn">ç™»å‡º</button>
        </div>
    </div>
    <div id="status-panel" class="hud">
        <h1>NEON CHESS</h1>
        <div id="turn-txt">ç­‰å¾…å°æˆ°</div>
        <div id="opponent-info" style="font-size: 12px; color: #aaa;">å°æ‰‹: ---</div>
    </div>
</div>

<div id="menu-backdrop" onclick="closeAllMenus()"></div>
<div id="custom-panel" class="side-panel">
    <h2>è¨­å®š</h2>
    <div class="custom-section">
        <input type="text" id="avatar-seed" class="custom-input" placeholder="è¼¸å…¥ä»£ç¢¼">
        <img id="my-avatar" src="" class="mini-avatar" style="width:60px; height:60px;">
        <button id="btn-save-custom" class="game-btn">ä¿å­˜</button>
    </div>
    <div class="custom-section">
        <h3>æ¨¡å‹é¢¨æ ¼</h3>
        <div class="skin-grid" id="piece-skin-grid">
            <div class="skin-item selected" data-val="neon" onclick="previewSkin('piece','neon',this)"><div class="skin-icon">ğŸ’ </div>éœ“è™¹</div>
            <div class="skin-item" data-val="classic" onclick="previewSkin('piece','classic',this)"><div class="skin-icon">â™Ÿï¸</div>ç¶“å…¸</div>
        </div>
        <input type="hidden" id="selected-piece-style" value="neon">
        <input type="hidden" id="selected-board-style" value="neon">
    </div>
    <button onclick="closeAllMenus()" class="game-btn" style="background:#333;">é—œé–‰</button>
</div>

<script type="module">
    import { initGame, switchGameMode, triggerAvatarUpload, previewStyle } from './game_logic.js';
    
    // å…¨åŸŸç¶å®š
    window.switchMode = (m) => {
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('mode-'+m).classList.add('active');
        switchGameMode(m);
    }
    window.previewSkin = (t, v, el) => {
        const grid = document.getElementById(`${t}-skin-grid`);
        if(!grid) return;
        for(let item of grid.children) item.classList.remove('selected');
        el.classList.add('selected');
        document.getElementById(`selected-${t}-style`).value = v;
        previewStyle(t, v);
    }
    window.triggerAvatarUpload = triggerAvatarUpload;
    
    window.toggleMenu = () => {
        const p = document.getElementById('menu-panel');
        p.classList.toggle('mobile-visible');
        const b = document.getElementById('menu-backdrop');
        if(p.classList.contains('mobile-visible')) b.classList.add('active');
        else b.classList.remove('active');
    }
    window.closeAllMenus = () => {
        document.getElementById('custom-panel').classList.remove('active');
        document.getElementById('menu-panel').classList.remove('mobile-visible');
        document.getElementById('menu-backdrop').classList.remove('active');
    }

    // å•Ÿå‹•éŠæˆ²
    window.onload = () => initGame();
</script>
</body>
</html>
