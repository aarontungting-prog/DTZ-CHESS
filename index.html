<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Avia WebGL Racer V2</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; background-color: #87CEEB; user-select: none; }
        #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: none; flex-direction: column; justify-content: center; align-items: center; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(8px); }
        .screen.active { display: flex; }
        .transparent-screen { background: none; backdrop-filter: none; pointer-events: none; }
        
        h1 { font-size: 3.5rem; color: #2c3e50; text-shadow: 2px 2px 0px #fff; margin-bottom: 10px; }
        button { margin: 10px; padding: 15px 40px; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 30px; background: #e74c3c; color: white; cursor: pointer; box-shadow: 0 6px 0 #c0392b; transition: all 0.1s; pointer-events: auto; }
        button:active { transform: translateY(6px); box-shadow: 0 0 0 #c0392b; }
        button.green { background: #2ecc71; box-shadow: 0 6px 0 #27ae60; }
        button.green:active { box-shadow: 0 0 0 #27ae60; }
        
        #hud { position: absolute; top: 20px; left: 20px; color: white; font-size: 1.5rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); pointer-events: none; z-index: 10; font-family: monospace;}
        #builder-panel { position: absolute; bottom: 30px; background: rgba(0,0,0,0.7); padding: 20px; border-radius: 20px; display: flex; gap: 15px; pointer-events: auto; z-index: 10; border: 2px solid rgba(255,255,255,0.2);}
        .part-btn { background: #3498db; color: white; padding: 15px 20px; border-radius: 12px; cursor: pointer; font-weight: bold; text-align: center; transition: transform 0.1s;}
        .part-btn:active { transform: scale(0.9); }
        
        #controls-hint { position: absolute; bottom: 20px; right: 20px; color: white; text-shadow: 1px 1px 3px black; font-size: 1rem; text-align: right; pointer-events: none; z-index: 10; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 10px;}
        
        /* 倒數計時特效 */
        #countdown-display { font-size: 8rem; color: #f1c40f; text-shadow: 4px 4px 0 #d35400; display: none; z-index: 20; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); animation: pop 1s infinite; }
        @keyframes pop { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <div id="countdown-display">3</div>

    <div id="main-menu" class="screen active">
        <h1>Avia Racer V2</h1>
        <button onclick="changeScreen('garage')">進入機庫 (組裝飛機)</button>
        <button class="green" onclick="joinLobby()">多人連線大廳</button>
    </div>

    <div id="garage" class="screen transparent-screen">
        <button style="position: absolute; top: 20px; left: 20px;" onclick="changeScreen('main-menu')">⬅ 返回主選單</button>
        <div style="position: absolute; top: 80px; left: 20px; color: white; background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; pointer-events: none;">
            <h3 style="margin:0 0 10px 0;">飛機性能 (Stats)</h3>
            速度: <span id="stat-speed">100</span><br>操控: <span id="stat-control">50</span><br>升力: <span id="stat-lift">50</span>
        </div>
        <div id="builder-panel">
            <div class="part-btn" onclick="addPart('wing')">機翼<br><small>+20 升力</small></div>
            <div class="part-btn" onclick="addPart('engine')">引擎<br><small>+30 速度</small></div>
            <div class="part-btn" onclick="addPart('tail')">尾翼<br><small>+20 操控</small></div>
            <div class="part-btn" style="background:#e74c3c;" onclick="resetParts()">重置</div>
        </div>
    </div>

    <div id="lobby" class="screen">
        <h2 style="font-size: 2.5rem;">大廳準備中...</h2>
        <div id="player-list" style="margin-bottom: 30px; font-size: 1.5rem; background: #ecf0f1; padding: 20px; border-radius: 15px; min-width: 300px; text-align: center;">連線中...</div>
        <button class="green" onclick="startCountdown()">準備出發！</button>
        <button onclick="changeScreen('main-menu')">離開大廳</button>
    </div>

    <div id="game-ui" class="screen transparent-screen">
        <div id="hud">SPD: <span id="speed-display">0</span> km/h<br>ALT: <span id="alt-display">0</span> m</div>
        <div id="controls-hint">W/S: 俯仰 (Pitch)<br>A/D: 翻滾 (Roll)<br>Q/E: 偏航 (Yaw)<br>Shift: 加速 | Space: 減速</div>
    </div>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
                "firebase/database": "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { initializeApp } from "firebase/app";
        import { getDatabase, ref, set, onValue, onDisconnect } from "firebase/database";

        const firebaseConfig = {
            apiKey: "AIzaSyCnONA7vSsBwOcui-bVBmmZfD_TOVZmck0",
            authDomain: "airplane-game-68f8f.firebaseapp.com",
            projectId: "airplane-game-68f8f",
            databaseURL: "https://airplane-game-68f8f-default-rtdb.firebaseio.com/" 
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentScreen = 'main-menu';
        let playerId = "P_" + Math.floor(Math.random() * 9999);
        let players = {}; 
        let isGameActive = false;

        // 飛機屬性與部件記錄
        let baseStats = { speed: 100, control: 50, lift: 50 };
        let planeStats = { ...baseStats };
        let myPartsList = []; // 紀錄玩家裝了什麼部件，用來同步給別人

        // --- Three.js 場景設定 ---
        const container = document.getElementById('game-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x6dd5ed); 
        scene.fog = new THREE.FogExp2(0x6dd5ed, 0.0015);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 3000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        // 光影
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
        scene.add(hemiLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(200, 500, 300);
        dirLight.castShadow = true;
        dirLight.shadow.camera.top = 500;
        dirLight.shadow.camera.bottom = -500;
        dirLight.shadow.camera.left = -500;
        dirLight.shadow.camera.right = 500;
        scene.add(dirLight);

        // 卡通風格地面
        const groundGeo = new THREE.PlaneGeometry(4000, 4000, 50, 50);
        // 讓地面有一點點高低起伏
        const posAttribute = groundGeo.attributes.position;
        for (let i = 0; i < posAttribute.count; i++) {
            posAttribute.setZ(i, Math.random() * 15);
        }
        groundGeo.computeVertexNormals();
        const groundMat = new THREE.MeshStandardMaterial({ color: 0x2ecc71, flatShading: true });
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // 隨機樹木障礙物 (使用 Group 組合樹幹與樹葉)
        for(let i=0; i<150; i++) {
            const treeGroup = new THREE.Group();
            const trunkGeo = new THREE.CylinderGeometry(2, 2, 10);
            const trunkMat = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
            const trunk = new THREE.Mesh(trunkGeo, trunkMat);
            trunk.position.y = 5;
            trunk.castShadow = true;
            
            const leavesGeo = new THREE.ConeGeometry(8, 20, 5);
            const leavesMat = new THREE.MeshStandardMaterial({ color: 0x27ae60, flatShading: true });
            const leaves = new THREE.Mesh(leavesGeo, leavesMat);
            leaves.position.y = 20;
            leaves.castShadow = true;
            
            treeGroup.add(trunk);
            treeGroup.add(leaves);
            treeGroup.position.set((Math.random()-0.5)*3000, 0, (Math.random()-0.5)*3000);
            scene.add(treeGroup);
        }

        // 立體雲朵
        for(let i=0; i<40; i++) {
            const cloudGeo = new THREE.DodecahedronGeometry(Math.random() * 30 + 20, 1);
            const cloudMat = new THREE.MeshStandardMaterial({ color: 0xffffff, flatShading: true });
            const cloud = new THREE.Mesh(cloudGeo, cloudMat);
            cloud.position.set((Math.random()-0.5)*3000, 200 + Math.random()*300, (Math.random()-0.5)*3000);
            scene.add(cloud);
        }
        // --- 飛機建構系統 ---
        const myPlaneGroup = new THREE.Group();
        scene.add(myPlaneGroup);
        myPlaneGroup.position.set(0, 10, 0);

        // 用來生成單一飛機的函數 (自己或對手共用)
        function buildPlane(group, partsArray) {
            // 清空舊部件
            while(group.children.length > 0){ 
                group.remove(group.children[0]); 
            }

            // 核心機身
            const bodyGeo = new THREE.BoxGeometry(3, 3, 8);
            const bodyMat = new THREE.MeshStandardMaterial({ color: 0xe74c3c, flatShading: true });
            const body = new THREE.Mesh(bodyGeo, bodyMat);
            body.castShadow = true;
            group.add(body);

            // 根據陣列加裝部件
            let wingCount = 0, engineCount = 0, tailCount = 0;
            partsArray.forEach(type => {
                let mesh;
                if (type === 'wing') {
                    mesh = new THREE.Mesh(new THREE.BoxGeometry(16, 0.5, 3), new THREE.MeshStandardMaterial({ color: 0xecf0f1 }));
                    mesh.position.set(0, 0, -wingCount * 2);
                    wingCount++;
                } else if (type === 'engine') {
                    mesh = new THREE.Mesh(new THREE.CylinderGeometry(1.2, 1.2, 4, 8), new THREE.MeshStandardMaterial({ color: 0x34495e }));
                    mesh.rotation.x = Math.PI / 2;
                    mesh.position.set(0, 0, 4 + engineCount * 2);
                    engineCount++;
                } else if (type === 'tail') {
                    mesh = new THREE.Mesh(new THREE.BoxGeometry(6, 0.5, 2), new THREE.MeshStandardMaterial({ color: 0xf1c40f }));
                    mesh.position.set(0, 2, -3 - tailCount);
                    // 垂直尾翼
                    const vTail = new THREE.Mesh(new THREE.BoxGeometry(0.5, 3, 2), new THREE.MeshStandardMaterial({ color: 0xf1c40f }));
                    vTail.position.set(0, 1.5, 0);
                    mesh.add(vTail);
                    tailCount++;
                }
                if(mesh) {
                    mesh.castShadow = true;
                    group.add(mesh);
                }
            });
        }

        // 初始建構自己的飛機
        buildPlane(myPlaneGroup, myPartsList);

        // UI 點擊加裝部件
        window.addPart = function(type) {
            myPartsList.push(type);
            if(type === 'wing') planeStats.lift += 20;
            if(type === 'engine') planeStats.speed += 30;
            if(type === 'tail') planeStats.control += 20;
            
            document.getElementById('stat-speed').innerText = planeStats.speed;
            document.getElementById('stat-control').innerText = planeStats.control;
            document.getElementById('stat-lift').innerText = planeStats.lift;
            
            buildPlane(myPlaneGroup, myPartsList);
        };

        window.resetParts = function() {
            myPartsList = [];
            planeStats = { ...baseStats };
            document.getElementById('stat-speed').innerText = planeStats.speed;
            document.getElementById('stat-control').innerText = planeStats.control;
            document.getElementById('stat-lift').innerText = planeStats.lift;
            buildPlane(myPlaneGroup, myPartsList);
        };

        // --- Firebase 多人同步 ---
        function updateMultiplayer() {
            if (!isGameActive) return;
            const playerRef = ref(db, 'players/' + playerId);
            // 這次連同 parts 陣列一起轉成字串上傳
            set(playerRef, {
                x: myPlaneGroup.position.x, y: myPlaneGroup.position.y, z: myPlaneGroup.position.z,
                rx: myPlaneGroup.rotation.x, ry: myPlaneGroup.rotation.y, rz: myPlaneGroup.rotation.z,
                parts: myPartsList.join(',')
            });
        }

        onValue(ref(db, 'players'), (snapshot) => {
            const data = snapshot.val();
            let count = data ? Object.keys(data).length : 0;
            document.getElementById('player-list').innerText = `已連線玩家: ${count} 人`;
            
            if(!data || !isGameActive) return;

            for (let id in data) {
                if (id === playerId) continue;

                if (!players[id]) {
                    // 發現新玩家，為他建立一個專屬 Group
                    players[id] = { group: new THREE.Group(), partsStr: "" };
                    scene.add(players[id].group);
                }
                
                // 如果對手的部件組合改變了，就重新渲染他的飛機
                if(players[id].partsStr !== data[id].parts) {
                    players[id].partsStr = data[id].parts;
                    let oppPartsArray = data[id].parts ? data[id].parts.split(',') : [];
                    buildPlane(players[id].group, oppPartsArray);
                }

                players[id].group.position.set(data[id].x, data[id].y, data[id].z);
                players[id].group.rotation.set(data[id].rx, data[id].ry, data[id].rz);
            }
            
            for (let id in players) {
                if (!data[id]) {
                    scene.remove(players[id].group);
                    delete players[id];
                }
            }
        });
        onDisconnect(ref(db, 'players/' + playerId)).remove();
        // --- 飛行物理與控制 ---
        let keys = { w: false, a: false, s: false, d: false, q: false, e: false, shift: false, space: false };
        let velocity = 0;
        const GRAVITY = 30; // 重力常數
        
        window.addEventListener('keydown', (e) => { if(e.key.toLowerCase() in keys) keys[e.key.toLowerCase()] = true; });
        window.addEventListener('keyup', (e) => { if(e.key.toLowerCase() in keys) keys[e.key.toLowerCase()] = false; });

        // 攝影機追蹤設定
        const cameraOffset = new THREE.Vector3(0, 8, 25);

        function updatePhysics(delta) {
            if (!isGameActive) return;

            // 引擎推力 (Thrust)
            let targetSpeed = keys.shift ? planeStats.speed * 1.5 : (keys.space ? 0 : planeStats.speed);
            velocity += (targetSpeed - velocity) * 1.5 * delta;

            // 空氣動力學 (升力與重力)
            // 速度越快，升力越大；機翼越多，升力係數越高
            let currentLift = (velocity / 100) * (planeStats.lift * 0.8);
            let verticalVelocity = currentLift - GRAVITY;
            
            // 轉向控制
            let turnSpeed = (planeStats.control / 100) * delta * 1.5;
            if (keys.w) myPlaneGroup.rotateX(turnSpeed);   // Pitch Down
            if (keys.s) myPlaneGroup.rotateX(-turnSpeed);  // Pitch Up
            if (keys.a) myPlaneGroup.rotateZ(turnSpeed);   // Roll Left
            if (keys.d) myPlaneGroup.rotateZ(-turnSpeed);  // Roll Right
            if (keys.q) myPlaneGroup.rotateY(turnSpeed);   // Yaw Left (偏航左)
            if (keys.e) myPlaneGroup.rotateY(-turnSpeed);  // Yaw Right (偏航右)

            // 自動回正機制 (Roll 輕微自動回正，增加飛行穩定性)
            if(!keys.a && !keys.d) {
                myPlaneGroup.rotation.z -= myPlaneGroup.rotation.z * 2 * delta;
            }

            // 前進與高度變化
            myPlaneGroup.translateZ(-velocity * delta);
            // 額外加上升力與重力的影響 (在世界座標的 Y 軸)
            myPlaneGroup.position.y += verticalVelocity * delta;

            // 地面碰撞判定
            if (myPlaneGroup.position.y < 3) {
                myPlaneGroup.position.y = 3;
                velocity *= 0.9; // 撞地減速
                // 限制不能鑽入地下
                if(myPlaneGroup.rotation.x < 0) myPlaneGroup.rotation.x *= 0.8; 
            }

            // 更新 HUD
            document.getElementById('speed-display').innerText = Math.round(velocity * 5);
            document.getElementById('alt-display').innerText = Math.round(myPlaneGroup.position.y);

            // 攝影機平滑跟隨
            const relativeOffset = cameraOffset.clone().applyMatrix4(myPlaneGroup.matrixWorld);
            camera.position.lerp(relativeOffset, 0.1);
            camera.lookAt(myPlaneGroup.position);
        }

        // --- 畫面切換與比賽流程 ---
        window.changeScreen = function(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            currentScreen = screenId;

            if (screenId === 'garage') {
                isGameActive = false;
                myPlaneGroup.position.set(0, 10, 0);
                myPlaneGroup.rotation.set(0, 0, 0);
                camera.position.set(15, 15, 15);
                camera.lookAt(myPlaneGroup.position);
            }
        };
        window.joinLobby = () => changeScreen('lobby');

        // 倒數計時邏輯
        window.startCountdown = function() {
            changeScreen('game-ui');
            isGameActive = false; // 鎖定操作
            myPlaneGroup.position.set(0, 5, 0); // 回到起點
            myPlaneGroup.rotation.set(0, 0, 0);
            velocity = 0;

            const countdownEl = document.getElementById('countdown-display');
            countdownEl.style.display = 'block';
            let count = 3;
            countdownEl.innerText = count;

            let timer = setInterval(() => {
                count--;
                if(count > 0) {
                    countdownEl.innerText = count;
                } else if(count === 0) {
                    countdownEl.innerText = "GO!";
                } else {
                    clearInterval(timer);
                    countdownEl.style.display = 'none';
                    isGameActive = true; // 解鎖操作，比賽開始！
                }
            }, 1000);
        };

        // --- Game Loop ---
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            
            if (currentScreen === 'garage') {
                myPlaneGroup.rotation.y += 0.5 * delta; // 車庫展示旋轉
            }

            updatePhysics(delta);
            updateMultiplayer();
            
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>
