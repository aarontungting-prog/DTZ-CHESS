<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Avia Racer PRO - Ultimate Edition</title>
    <style>
        /* åŸºç¤é‡ç½®èˆ‡å…¨è¢å¹•è¨­å®š */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1a2a6c; user-select: none; -webkit-touch-callout: none; }
        #game-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* UI ç•«é¢å…±ç”¨æ¨£å¼ */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: none; flex-direction: column; justify-content: center; align-items: center; background: rgba(20, 30, 48, 0.85); backdrop-filter: blur(10px); color: white; }
        .screen.active { display: flex; }
        .transparent-screen { background: none; backdrop-filter: none; } 
        
        /* æ¨™é¡Œèˆ‡æŒ‰éˆ• */
        h1 { font-size: 4rem; color: #fff; text-shadow: 0 0 10px #00ffcc, 0 0 20px #00ffcc; margin-bottom: 20px; text-align: center; font-style: italic;}
        button { margin: 10px; padding: 15px 35px; font-size: 1.2rem; font-weight: bold; border: none; border-radius: 8px; background: #e74c3c; color: white; cursor: pointer; box-shadow: 0 4px 15px rgba(231, 76, 60, 0.5); transition: all 0.2s; pointer-events: auto; text-transform: uppercase; letter-spacing: 2px;}
        button:active { transform: scale(0.95); box-shadow: 0 2px 5px rgba(231, 76, 60, 0.5); }
        button.green { background: #00ffcc; color: #111; box-shadow: 0 4px 15px rgba(0, 255, 204, 0.4); }
        button.green:active { box-shadow: 0 2px 5px rgba(0, 255, 204, 0.4); }
        button:disabled { background: #555; color: #888; cursor: not-allowed; box-shadow: none;}
        
        /* è¼¸å…¥æ¡† */
        input[type="text"] { padding: 15px; font-size: 1.2rem; border-radius: 8px; border: 2px solid #00ffcc; background: rgba(0,0,0,0.5); color: #00ffcc; text-align: center; margin-bottom: 15px; outline: none; width: 80%; max-width: 300px; transition: box-shadow 0.3s;}
        input[type="text"]:focus { box-shadow: 0 0 15px rgba(0, 255, 204, 0.5); }
        
        /* éŠæˆ²å…§å„€è¡¨æ¿ (HUD) */
        #hud, #race-hud { position: absolute; top: 20px; font-size: 1.2rem; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.9); pointer-events: none; z-index: 10; display: none; background: rgba(0,0,0,0.4); padding: 10px 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);}
        #hud { left: 20px; color: #00ffcc; font-family: 'Courier New', Courier, monospace; }
        #race-hud { right: 20px; color: #f1c40f; text-align: right; }
        
        /* é£›æ©Ÿè£é…é¢æ¿ */
        #builder-panel { position: absolute; bottom: 30px; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 12px; display: flex; gap: 15px; pointer-events: auto; z-index: 10; justify-content: center; flex-wrap: wrap; width: 90%; max-width: 600px; border: 1px solid #00ffcc; box-shadow: 0 0 20px rgba(0, 255, 204, 0.2);}
        .part-btn { background: #2c3e50; border: 1px solid #34495e; color: white; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.2s;}
        .part-btn:hover { background: #34495e; border-color: #00ffcc; }
        
        /* å€’æ•¸èˆ‡å¢œæ¯€ç‰¹æ•ˆ */
        #countdown-display { font-size: 8rem; color: #fff; text-shadow: 0 0 20px #f1c40f, 0 0 40px #f1c40f; display: none; z-index: 20; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); animation: pop 1s infinite; pointer-events: none; font-style: italic;}
        @keyframes pop { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1); opacity: 0; } }
        #crash-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(231,76,60,0.8) 0%, rgba(0,0,0,0.9) 100%); z-index: 30; display: none; justify-content: center; align-items: center; color: white; font-size: 5rem; font-weight: bold; text-shadow: 0 0 20px #000; pointer-events: none; letter-spacing: 5px;}

        /* åç‰Œç³»çµ± */
        .nametag { position: absolute; color: #fff; background: rgba(0, 0, 0, 0.7); padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; font-weight: bold; pointer-events: none; transform: translate(-50%, -50%); display: none; z-index: 5; border: 1px solid rgba(255, 255, 255, 0.2); text-shadow: 1px 1px 2px #000;}
        .ai-tag { color: #ff9999; border-color: rgba(231, 76, 60, 0.5); }

        /* æ‰‹æ©Ÿè™›æ“¬æŒ‰éµ */
        #touch-controls { position: absolute; bottom: 30px; width: 100%; display: none; justify-content: space-between; pointer-events: none; z-index: 15; padding: 0 30px; box-sizing: border-box;}
        .touch-group { display: flex; gap: 15px; pointer-events: auto; }
        .touch-btn { width: 65px; height: 65px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; color: white; font-size: 1.8rem; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); transition: background 0.1s;}
        .touch-btn:active { background: rgba(0, 255, 204, 0.4); border-color: #00ffcc; }

        @media (max-width: 768px) { 
            #touch-controls { display: flex !important; } 
            h1 { font-size: 2.5rem; }
        }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
                "firebase/database": "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js"
            }
        }
    </script>
</head>
<body>
    <div id="game-container"></div>
    <div id="countdown-display">3</div>
    <div id="crash-screen">SYSTEM FAILURE</div>
    <div id="nametag-container"></div> 

    <div id="main-menu" class="screen active">
        <h1>AVIA RACER<br><span style="font-size: 2rem; color: #00ffcc;">PRO EDITION</span></h1>
        <input type="text" id="player-name" placeholder="è¼¸å…¥é£›è¡Œå“¡ä»£è™Ÿ" value="Maverick">
        <button onclick="changeScreen('garage')">ğŸ”§ é€²å…¥é«˜éšæ©Ÿåº«</button>
        <div style="background: rgba(0,0,0,0.6); padding: 25px; border-radius: 12px; margin-top: 20px; text-align: center; width: 80%; max-width: 350px; border: 1px solid rgba(255,255,255,0.1);">
            <h3 style="margin-top: 0; color: #aaa;">é€£ç·šç«¶é€Ÿè¨­å®š</h3>
            <input type="text" id="room-input" placeholder="é€£ç·šé »é“ (ä¾‹: 777)" value="777"><br>
            <button class="green" onclick="joinLobby()">é€£ç·šè‡³å¤§å»³</button>
        </div>
    </div>

    <div id="garage" class="screen transparent-screen">
        <button style="position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.5);" onclick="changeScreen('main-menu')">â¬… ä¸­æ­¢è£é…</button>
        <div style="position: absolute; top: 90px; left: 20px; color: #00ffcc; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 8px; border: 1px solid #00ffcc; font-family: monospace;">
            <div style="color: #fff; margin-bottom: 5px;">æ©Ÿé«”æ€§èƒ½åˆ†æ</div>
            é ‚é€Ÿ (SPD): <span id="stat-speed">100</span><br>
            æ©Ÿå‹• (CTRL): <span id="stat-control">50</span><br>
            å‡åŠ› (LIFT): <span id="stat-lift">50</span>
        </div>
        <div id="builder-panel">
            <div class="part-btn" onclick="addPart('wing')">â• é«˜å‡åŠ›æ©Ÿç¿¼</div>
            <div class="part-btn" onclick="addPart('engine')">â• æ¸¦è¼ªå¼•æ“</div>
            <div class="part-btn" onclick="addPart('tail')">â• ç¢³çº–ç¶­å°¾ç¿¼</div>
            <div class="part-btn" style="background:#c0392b; border-color:#e74c3c;" onclick="resetParts()">ğŸ”„ é‡ç½®æ©Ÿé«”</div>
        </div>
    </div>

    <div id="lobby" class="screen">
        <h2>é »é“: <span id="room-name-display" style="color: #00ffcc;"></span></h2>
        <div id="player-list" style="margin-bottom: 25px; font-size: 1.2rem; background: rgba(0,0,0,0.6); padding: 20px; border-radius: 8px; text-align: left; width: 80%; max-width: 450px; min-height: 150px; border: 1px solid rgba(255,255,255,0.2);"></div>
        <button id="btn-ready" class="green" onclick="toggleReady()">æº–å‚™å°±ç·’ (READY)</button>
        <button id="btn-start" style="display: none; background: #f39c12;" onclick="hostStartGame()">å•Ÿå‹•è³½äº‹ (å«AI)</button>
        <button onclick="leaveLobby()" style="background: transparent; border: 1px solid #fff;">é›¢é–‹é »é“</button>
    </div>

    <div id="game-ui" class="screen transparent-screen">
        <div id="hud">
            THRUST: <span id="speed-display">0</span> KN<br>
            ALT: <span id="alt-display">0</span> FT
        </div>
        <div id="race-hud">
            LAP <span id="lap-display">1</span>/3<br>
            TARGET: <span id="chk-display">0</span> M
        </div>
        
        <div id="touch-controls">
            <div class="touch-group" style="flex-direction: column; align-items: center;">
                <div class="touch-btn" id="btn-up">â–²</div>
                <div style="display:flex; gap: 40px;">
                    <div class="touch-btn" id="btn-left">â—€</div>
                    <div class="touch-btn" id="btn-right">â–¶</div>
                </div>
                <div class="touch-btn" id="btn-down">â–¼</div>
            </div>
            <div class="touch-group" style="flex-direction: column; justify-content: center; gap: 20px;">
                <div class="touch-btn" id="btn-boost" style="background: rgba(231, 76, 60, 0.4); border-color: #e74c3c;">ğŸš€</div>
                <div class="touch-btn" id="btn-slow" style="background: rgba(52, 152, 219, 0.4); border-color: #3498db;">ğŸ›‘</div>
            </div>
        </div>
    </div>
    <script type="module">
        import * as THREE from 'three';
        import { initializeApp } from "firebase/app";
        import { getDatabase, ref, set, onValue, onDisconnect, remove, update } from "firebase/database";

        // --- Firebase åˆå§‹åŒ– ---
        const firebaseConfig = {
            apiKey: "AIzaSyCnONA7vSsBwOcui-bVBmmZfD_TOVZmck0",
            authDomain: "airplane-game-68f8f.firebaseapp.com",
            projectId: "airplane-game-68f8f",
            databaseURL: "https://airplane-game-68f8f-default-rtdb.firebaseio.com/" 
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- å…¨åŸŸè®Šæ•¸ç‹€æ…‹ ---
        let currentScreen = 'main-menu';
        let playerId = "P_" + Math.floor(Math.random() * 99999);
        let playerName = "Maverick";
        let currentRoomId = null; 
        let isHost = false, isReady = false, isGameActive = false;
        let myGridIndex = 0; 
        let players = {}; 
        let aiBots = []; 

        // åŸºç¤ç‰©ç†èˆ‡çµ„è£æ•¸å€¼
        let baseStats = { speed: 120, control: 60, lift: 50 };
        let planeStats = { ...baseStats };
        let myPartsList = []; 

        // è³½é“èˆªé»èˆ‡èµ·è·‘æ ¼
        const trackPoints = [
            new THREE.Vector3(0, 50, -400), new THREE.Vector3(300, 80, -800),
            new THREE.Vector3(600, 50, -400), new THREE.Vector3(300, 60, 0)
        ];
        const spawnGrid = [
            new THREE.Vector3(0, 20, 80), new THREE.Vector3(40, 20, 120),
            new THREE.Vector3(-40, 20, 120), new THREE.Vector3(80, 20, 160),
            new THREE.Vector3(-80, 20, 160), new THREE.Vector3(0, 20, 200)
        ];
        let currentTargetIndex = 0; let currentLap = 1;

        // --- Three.js æ ¸å¿ƒç’°å¢ƒè¨­å®š ---
        const container = document.getElementById('game-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a192f); // æ·±è‰²ç§‘æŠ€æ„Ÿå¤©ç©º
        scene.fog = new THREE.FogExp2(0x0a192f, 0.0008); // é™ä½éœ§æ°£æ¿ƒåº¦æå‡è¦–é‡

        // æ”å½±æ©Ÿè¨­å®š
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 4000);
        
        // æ¸²æŸ“å™¨è¨­å®š (åš´æ ¼é™åˆ¶ pixelRatio ä»¥æ¦¨ä¹¾æ‰‹æ©Ÿæ•ˆèƒ½)
        const renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5)); 
        renderer.setSize(window.innerWidth, window.innerHeight);
        // é–‹å•Ÿé™°å½±ï¼Œä½†ä½¿ç”¨æœ€åŸºç¤çš„è²¼åœ–ä»¥ç¯€çœæ•ˆèƒ½
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.BasicShadowMap; 
        container.appendChild(renderer.domElement);

        // --- å…‰å½±ç³»çµ± ---
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.5); 
        scene.add(hemiLight);
        
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.2); 
        dirLight.position.set(300, 800, 400); 
        dirLight.castShadow = true;
        // é™åˆ¶é™°å½±ç›¸æ©Ÿç¯„åœ (Frustum)ï¼Œè¦–é‡å¤–ä¸è¨ˆç®—é™°å½±
        dirLight.shadow.camera.top = 1000;
        dirLight.shadow.camera.bottom = -1000;
        dirLight.shadow.camera.left = -1000;
        dirLight.shadow.camera.right = 1000;
        dirLight.shadow.mapSize.width = 1024; // é™ä½é™°å½±è§£æåº¦
        dirLight.shadow.mapSize.height = 1024;
        scene.add(dirLight);

        // åœ°é¢
        const groundMat = new THREE.MeshStandardMaterial({ color: 0x05101c, roughness: 0.8, metalness: 0.2, flatShading: true });
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(8000, 8000, 10, 10), groundMat);
        ground.rotation.x = -Math.PI / 2; 
        ground.receiveShadow = true;
        scene.add(ground);

        // --- æ¦¨ä¹¾æ•ˆèƒ½ï¼šInstancedMesh æ£®æ—ç”Ÿæˆ ---
        const treeCount = 800; // æå‡æ¨¹æœ¨æ•¸é‡ï¼Œæ¸¬è©¦æ¥µé™
        const trunkGeo = new THREE.CylinderGeometry(2, 3, 20, 5); // é™ä½å¤šé‚Šå½¢æ•¸
        const trunkMat = new THREE.MeshStandardMaterial({ color: 0x1a0f0a, roughness: 1.0 });
        const leavesGeo = new THREE.ConeGeometry(12, 40, 5);
        const leavesMat = new THREE.MeshStandardMaterial({ color: 0x0a2e1f, roughness: 0.9, flatShading: true });
        
        const instancedTrunks = new THREE.InstancedMesh(trunkGeo, trunkMat, treeCount);
        const instancedLeaves = new THREE.InstancedMesh(leavesGeo, leavesMat, treeCount);
        // è®“æ¨¹æœ¨èƒ½æ¥æ”¶èˆ‡æŠ•å°„é™°å½±
        instancedTrunks.castShadow = true; instancedTrunks.receiveShadow = true;
        instancedLeaves.castShadow = true; instancedLeaves.receiveShadow = true;
        
        const dummy = new THREE.Object3D();

        for (let i = 0; i < treeCount; i++) {
            let x = (Math.random() - 0.5) * 3000;
            let z = (Math.random() - 0.5) * 3000;
            // æ·¨ç©ºä¸­å¤®èµ·è·‘å€
            if (Math.abs(x) < 150 && Math.abs(z) < 300) { x += 300 * Math.sign(x || 1); } 
            
            // æ¨¹å¹¹ä½ç½®
            dummy.position.set(x, 10, z);
            dummy.scale.set(1, 1, 1);
            dummy.updateMatrix();
            instancedTrunks.setMatrixAt(i, dummy.matrix);
            
            // æ¨¹è‘‰ä½ç½®èˆ‡éš¨æ©Ÿå¤§å°
            dummy.position.set(x, 30, z);
            let scale = 0.7 + Math.random() * 0.6;
            dummy.scale.set(scale, scale, scale);
            dummy.updateMatrix();
            instancedLeaves.setMatrixAt(i, dummy.matrix);
        }
        scene.add(instancedTrunks); scene.add(instancedLeaves);

        // --- è³½é“éœ“è™¹å…‰ç’° ---
        const rings = [];
        const ringGeo = new THREE.TorusGeometry(40, 1.5, 8, 32); // åŠ å¤§æª¢æŸ¥é»
        // ç™¼å…‰æè³ª
        const ringMat = new THREE.MeshBasicMaterial({ color: 0x00ffcc, transparent: true, opacity: 0.3, wireframe: true });
        const activeRingMat = new THREE.MeshBasicMaterial({ color: 0xff0055 });
        
        trackPoints.forEach((pos, i) => {
            const ring = new THREE.Mesh(ringGeo, i === 0 ? activeRingMat : ringMat);
            ring.position.copy(pos);
            ring.lookAt(i < trackPoints.length - 1 ? trackPoints[i+1] : trackPoints[0]);
            scene.add(ring); rings.push(ring);
        });

        // --- PBR é£›æ©Ÿæ¨¡å‹å»ºæ§‹ç³»çµ± ---
        const myPlaneGroup = new THREE.Group(); 
        scene.add(myPlaneGroup);

        // å…±ç”¨ PBR æè³ª (æ¸›å°‘è¨˜æ†¶é«”æ¶ˆè€—)
        const pbrBodyMat = new THREE.MeshStandardMaterial({ color: 0xeeeeee, metalness: 0.6, roughness: 0.2 });
        const pbrPartMat = new THREE.MeshStandardMaterial({ color: 0x222222, metalness: 0.8, roughness: 0.3 });
        const glassMat = new THREE.MeshPhysicalMaterial({ color: 0x000000, metalness: 0.9, roughness: 0.1, transmission: 0.9, transparent: true }); // ç»ç’ƒè³ªæ„Ÿ

        function buildPlane(group, partsArray) {
            // æ¸…ç†èˆŠç‰©ä»¶
            while(group.children.length > 0){ group.remove(group.children[0]); }
            
            // æµç·šå‹æ©Ÿèº«
            const body = new THREE.Mesh(new THREE.CylinderGeometry(2, 1.5, 10, 12), pbrBodyMat);
            body.rotation.x = Math.PI / 2;
            body.castShadow = true;
            group.add(body);

            // é§•é§›è‰™ (Cockpit)
            const cockpit = new THREE.Mesh(new THREE.CapsuleGeometry(1, 2, 4, 8), glassMat);
            cockpit.rotation.x = Math.PI / 2;
            cockpit.position.set(0, 1.5, -1);
            group.add(cockpit);

            let wC = 0, eC = 0, tC = 0;
            partsArray.forEach(type => {
                let mesh;
                if (type === 'wing') { 
                    mesh = new THREE.Mesh(new THREE.BoxGeometry(20, 0.3, 4), pbrPartMat); 
                    mesh.position.set(0, 0, -wC * 2.5); 
                    wC++; 
                }
                else if (type === 'engine') { 
                    mesh = new THREE.Group();
                    const shell = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 1.5, 5, 12), pbrPartMat); 
                    shell.rotation.x = Math.PI/2; 
                    const glow = new THREE.Mesh(new THREE.CircleGeometry(1.2, 12), new THREE.MeshBasicMaterial({color: 0x00ffff}));
                    glow.position.set(0, 0, 2.6); // å¼•æ“å™´ç™¼å£
                    mesh.add(shell); mesh.add(glow);
                    mesh.position.set(0, -0.5, 3 + eC * 2); 
                    eC++; 
                }
                else if (type === 'tail') { 
                    mesh = new THREE.Group();
                    const hTail = new THREE.Mesh(new THREE.BoxGeometry(8, 0.3, 2.5), pbrPartMat); 
                    const vTail = new THREE.Mesh(new THREE.BoxGeometry(0.3, 4, 3), pbrPartMat); 
                    vTail.position.set(0, 2, 0); 
                    mesh.add(hTail); mesh.add(vTail);
                    mesh.position.set(0, 0.5, -4.5 - tC); 
                    tC++; 
                }
                if(mesh) {
                    mesh.traverse(child => { if(child.isMesh) child.castShadow = true; });
                    group.add(mesh);
                }
            });
        }
        
        // åˆå§‹å»ºæ§‹
        buildPlane(myPlaneGroup, myPartsList);

        // UI çµ„è£é‚è¼¯
        window.addPart = function(type) { 
            myPartsList.push(type); 
            if(type==='wing') planeStats.lift += 30; 
            if(type==='engine') planeStats.speed += 40; 
            if(type==='tail') planeStats.control += 25; 
            
            document.getElementById('stat-speed').innerText = planeStats.speed;
            document.getElementById('stat-control').innerText = planeStats.control;
            document.getElementById('stat-lift').innerText = planeStats.lift;
            buildPlane(myPlaneGroup, myPartsList); 
        };
        
        window.resetParts = function() { 
            myPartsList = []; 
            planeStats = {...baseStats}; 
            document.getElementById('stat-speed').innerText = planeStats.speed;
            document.getElementById('stat-control').innerText = planeStats.control;
            document.getElementById('stat-lift').innerText = planeStats.lift;
            buildPlane(myPlaneGroup, myPartsList); 
        };
        // --- å°ˆæ¥­ç‰ˆ AI å°æ‰‹ç³»çµ± (AIBot) ---
        class AIBot {
            constructor(name, startGridIndex) {
                this.name = name;
                this.group = new THREE.Group();
                // AI é è¨­é…å‚™ç¨å¾®å¥½ä¸€é»ï¼Œå¢åŠ æŒ‘æˆ°æ€§
                buildPlane(this.group, ['wing', 'engine']); 
                scene.add(this.group);
                
                // AI åç‰Œ
                this.label = document.createElement('div');
                this.label.className = 'nametag ai-tag';
                this.label.innerText = "ğŸ¤– " + name;
                document.getElementById('nametag-container').appendChild(this.label);
                
                this.targetIndex = 0;
                this.velocity = 0;
                // åŸºç¤é€Ÿåº¦åŠ ä¸Šéš¨æ©Ÿè®Šæ•¸ï¼Œè®“æ¯å° AI éƒ½æœ‰ä¸åŒæ‰‹æ„Ÿ
                this.baseSpeed = 120 + Math.random() * 30; 
                this.liftCoefficient = 50 + Math.random() * 20;
                
                // å‹•æ…‹èµ·è·‘æ ¼æ’ä½
                let startPos = spawnGrid[startGridIndex % spawnGrid.length];
                this.group.position.copy(startPos);
                this.group.lookAt(trackPoints[0]);
            }

            update(delta) {
                // å¹³æ»‘åŠ é€Ÿ (Smooth Acceleration)
                this.velocity += (this.baseSpeed - this.velocity) * 2 * delta;
                
                // èˆªé»å°èˆªé‚è¼¯ (Steering Behavior)
                let targetPos = trackPoints[this.targetIndex];
                
                // è¨ˆç®—é¢å‘ç›®æ¨™æ‰€éœ€çš„æ—‹è½‰çŸ©é™£èˆ‡å››å…ƒæ•¸ (Quaternion)
                const targetQuaternion = new THREE.Quaternion();
                const dummyMatrix = new THREE.Matrix4();
                dummyMatrix.lookAt(this.group.position, targetPos, this.group.up);
                targetQuaternion.setFromRotationMatrix(dummyMatrix);
                
                // Slerp (çƒé¢ç·šæ€§æ’å€¼)ï¼šè®“ AI é£›æ©Ÿèƒ½åƒçœŸäººä¸€æ¨£æ“æœ‰å¹³æ»‘è½‰å‘çš„æ…£æ€§
                // æ•¸å­—è¶Šå°è½‰å‘è¶Šé²éˆï¼Œæ•¸å­—è¶Šå¤§è½‰å‘è¶Šç²¾æº–
                this.group.quaternion.slerp(targetQuaternion, 1.5 * delta);
                
                // æ¨¡æ“¬å‡åŠ› (ç°¡æ˜“ç‰ˆï¼Œè®“ AI ä¹Ÿèƒ½æ„Ÿå—åˆ°é‡åŠ›èˆ‡å‡åŠ›çš„å¹³è¡¡)
                let currentLift = (this.velocity / 100) * (this.liftCoefficient * 0.8);
                const GRAVITY = 30;
                this.group.position.y += (currentLift - GRAVITY) * delta;

                // é˜²æ­¢ AI é£›é€²åœ°åº•æˆ–é£›å‡ºå¤§æ°£å±¤
                if(this.group.position.y < 10) this.group.position.y = 10;
                if(this.group.position.y > 200) this.group.position.y = 200;

                // å‰é€²æ¨åŠ› (Thrust)
                this.group.translateZ(-this.velocity * delta);

                // æª¢æŸ¥æ˜¯å¦é€šéæª¢æŸ¥é» (Checkpoint)
                if (this.group.position.distanceTo(targetPos) < 60) {
                    this.targetIndex++;
                    if (this.targetIndex >= trackPoints.length) this.targetIndex = 0;
                }
            }
        }

        // --- Firebase å³æ™‚é€£ç·šèˆ‡æˆ¿é–“ç®¡ç† ---
        function updateMultiplayer() {
            if (!isGameActive || !currentRoomId) return; 
            // é™ä½å‚³é€é »ç‡å¯å„ªåŒ–æ•ˆèƒ½ï¼Œé€™è£¡æˆ‘å€‘åˆ©ç”¨ requestAnimationFrame çš„ç‰¹æ€§æŒçºŒåŒæ­¥
            update(ref(db, `rooms/${currentRoomId}/players/${playerId}`), { 
                x: myPlaneGroup.position.x, y: myPlaneGroup.position.y, z: myPlaneGroup.position.z, 
                rx: myPlaneGroup.rotation.x, ry: myPlaneGroup.rotation.y, rz: myPlaneGroup.rotation.z 
            });
        }

        window.joinLobby = function() {
            playerName = document.getElementById('player-name').value || "Maverick";
            currentRoomId = document.getElementById('room-input').value.trim();
            if(!currentRoomId) return alert("è«‹è¼¸å…¥é€£ç·šé »é“ï¼");
            
            document.getElementById('room-name-display').innerText = currentRoomId; 
            changeScreen('lobby');
            
            // ç›£è½æˆ¿é–“ç‹€æ…‹
            onValue(ref(db, `rooms/${currentRoomId}`), (snapshot) => {
                const roomData = snapshot.val();
                
                // æˆ¿é–“ä¸å­˜åœ¨ï¼Œæˆ‘å°±æ˜¯æˆ¿ä¸» (Host)
                if (!roomData) { 
                    isHost = true; 
                    set(ref(db, `rooms/${currentRoomId}/status`), 'waiting'); 
                    document.getElementById('btn-start').style.display = 'inline-block'; 
                }
                // æˆ¿ä¸»æŒ‰äº†é–‹å§‹ï¼Œæ‰€æœ‰äººé€²å…¥æœ¬åœ°å€’æ•¸ç¨‹åº
                else if (roomData.status === 'starting' && currentScreen === 'lobby') { 
                    startCountdownLocally(); 
                }

                const playersData = roomData ? roomData.players : null;
                let listHTML = ""; 
                let indexCounter = 0; 
                let allReady = true;

                if (playersData) {
                    for (let id in playersData) {
                        const p = playersData[id];
                        // æ ¹æ“šåŠ å…¥é †åºåˆ†é…èµ·è·‘æ’ä½
                        if (id === playerId) myGridIndex = indexCounter;
                        
                        listHTML += `<div style="padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 5px;">
                            ${p.name} ${indexCounter === 0 ? "ğŸ‘‘" : ""} 
                            <span style="float: right; color: ${p.ready ? '#00ffcc' : '#e74c3c'}">${p.ready ? "âœ”ï¸ READY" : "âŒ WAIT"}</span>
                        </div>`;
                        
                        if (!p.ready) allReady = false;
                        
                        // è™•ç†å°æ‰‹ 3D æ¨¡å‹çš„ç”Ÿæˆèˆ‡åŒæ­¥
                        if (id !== playerId && isGameActive) {
                            if (!players[id]) {
                                players[id] = { group: new THREE.Group(), partsStr: "", label: document.createElement('div') };
                                players[id].label.className = 'nametag'; 
                                players[id].label.innerText = p.name;
                                document.getElementById('nametag-container').appendChild(players[id].label); 
                                scene.add(players[id].group);
                            }
                            // å¦‚æœå°æ‰‹æ›´æ”¹äº†é£›æ©Ÿé…ç½®ï¼Œé‡æ–°å»ºæ§‹æ¨¡å‹
                            if(players[id].partsStr !== p.parts) { 
                                players[id].partsStr = p.parts; 
                                buildPlane(players[id].group, p.parts ? p.parts.split(',') : []); 
                            }
                            players[id].group.position.set(p.x, p.y, p.z); 
                            players[id].group.rotation.set(p.rx, p.ry, p.rz);
                        }
                        indexCounter++;
                    }
                }
                document.getElementById('player-list').innerHTML = listHTML || "ç­‰å¾…å…¶ä»–é£›è¡Œå“¡åŠ å…¥...";
                // æˆ¿ä¸»å¿…é ˆç­‰æ‰€æœ‰äººéƒ½ Ready æ‰èƒ½æŒ‰é–‹å§‹
                if (isHost) {
                    const startBtn = document.getElementById('btn-start');
                    startBtn.disabled = !allReady;
                    startBtn.style.opacity = allReady ? 1 : 0.5;
                }
            });
            
            // æ–·ç·šæ™‚è‡ªå‹•ç§»é™¤è‡ªå·±çš„è³‡æ–™
            onDisconnect(ref(db, `rooms/${currentRoomId}/players/${playerId}`)).remove();
            // å¯«å…¥è‡ªå·±çš„åˆå§‹ç‹€æ…‹
            set(ref(db, `rooms/${currentRoomId}/players/${playerId}`), { name: playerName, ready: false, parts: myPartsList.join(',') });
        };

        window.toggleReady = function() { 
            isReady = !isReady; 
            const btn = document.getElementById('btn-ready');
            btn.innerText = isReady ? "å–æ¶ˆæº–å‚™" : "æº–å‚™å°±ç·’ (READY)"; 
            btn.style.background = isReady ? "#e74c3c" : "#00ffcc";
            btn.style.color = isReady ? "#fff" : "#111";
            update(ref(db, `rooms/${currentRoomId}/players/${playerId}`), { ready: isReady, parts: myPartsList.join(',') }); 
        };
        
        window.hostStartGame = function() { 
            if(isHost) set(ref(db, `rooms/${currentRoomId}/status`), 'starting'); 
        };
        
        window.leaveLobby = function() { 
            if(currentRoomId) remove(ref(db, `rooms/${currentRoomId}/players/${playerId}`)); 
            currentRoomId = null; isHost = false; isReady = false; 
            document.getElementById('btn-start').style.display = 'none'; 
            changeScreen('main-menu'); 
        };
        // --- æ§åˆ¶è¼¸å…¥ç³»çµ± (Input System) ---
        let keys = { w: false, a: false, s: false, d: false, shift: false, space: false };
        let velocity = 0; 
        
        // éµç›¤ç›£è½
        window.addEventListener('keydown', (e) => { if(e.key.toLowerCase() in keys) keys[e.key.toLowerCase()] = true; });
        window.addEventListener('keyup', (e) => { if(e.key.toLowerCase() in keys) keys[e.key.toLowerCase()] = false; });

        // æ‰‹æ©Ÿè™›æ“¬è§¸æ§ç¶å®š
        const bindT = (id, k) => { 
            const el = document.getElementById(id);
            if(el) {
                el.addEventListener('touchstart', (e)=>{ e.preventDefault(); keys[k]=true; }); 
                el.addEventListener('touchend', (e)=>{ e.preventDefault(); keys[k]=false; }); 
            }
        };
        bindT('btn-up','w'); bindT('btn-down','s'); bindT('btn-left','a'); bindT('btn-right','d'); bindT('btn-boost','shift'); bindT('btn-slow','space');

        const cameraOffset = new THREE.Vector3(0, 10, 35); // è®“è¦–é‡æ›´å»£é—Š

        // --- åç‰Œåº§æ¨™æŠ•å½±ç³»çµ± (UI Projection) ---
        function updateNameTags() {
            // åˆä½µçœŸäººç©å®¶èˆ‡ AI çš„é™£åˆ—
            const allEntities = [...Object.values(players), ...aiBots];
            allEntities.forEach(ent => {
                if(ent.group && ent.label) {
                    const tempV = new THREE.Vector3();
                    ent.group.getWorldPosition(tempV);
                    tempV.y += 8; // è®“åå­—é£„åœ¨é£›æ©Ÿä¸Šæ–¹
                    tempV.project(camera); // æ ¸å¿ƒï¼šå°‡ 3D åº§æ¨™è½‰æ›ç‚º -1 åˆ° 1 çš„ 2D è¢å¹•æ¯”ä¾‹
                    
                    if(tempV.z > 1) { 
                        // z > 1 ä»£è¡¨ç‰©é«”åœ¨æ”å½±æ©ŸèƒŒå¾Œï¼Œéš±è—åç‰Œ
                        ent.label.style.display = 'none';
                    } else {
                        const x = (tempV.x * 0.5 + 0.5) * window.innerWidth;
                        const y = (tempV.y * -0.5 + 0.5) * window.innerHeight;
                        ent.label.style.display = 'block';
                        ent.label.style.left = `${x}px`;
                        ent.label.style.top = `${y}px`;
                    }
                }
            });
        }

        // --- å¢œæ©Ÿèˆ‡é‡ç”Ÿæ©Ÿåˆ¶ (Crash & Respawn) ---
        function handleCrash() {
            isGameActive = false; 
            document.getElementById('crash-screen').style.display = 'flex';
            
            // è¢å¹•éœ‡å‹•ç‰¹æ•ˆ
            document.body.style.transform = "translate(5px, 5px)";
            setTimeout(() => document.body.style.transform = "translate(-5px, -5px)", 50);
            setTimeout(() => document.body.style.transform = "translate(0, 0)", 100);

            setTimeout(() => {
                document.getElementById('crash-screen').style.display = 'none';
                // å¾©æ´»åœ¨ä¸Šä¸€éé—œçš„æª¢æŸ¥é»ï¼Œæˆ–æ˜¯èµ·è·‘ç·š
                let respawnPos = currentTargetIndex === 0 ? spawnGrid[myGridIndex % spawnGrid.length] : trackPoints[currentTargetIndex - 1];
                myPlaneGroup.position.copy(respawnPos); 
                myPlaneGroup.rotation.set(0, 0, 0);
                velocity = 0; 
                isGameActive = true;
            }, 2000);
        }

        // --- æ ¸å¿ƒç‰©ç†å¼•æ“ (Physics Engine) ---
        function updatePhysics(delta) {
            // 1. æ¨åŠ›èˆ‡é˜»åŠ› (Thrust & Drag)
            let targetSpeed = keys.shift ? planeStats.speed * 1.5 : (keys.space ? 50 : planeStats.speed);
            // åŠ å…¥å¹³æ»‘åŠ é€Ÿèˆ‡ç©ºæ°£é˜»åŠ›æ¨¡æ“¬
            velocity += (targetSpeed - velocity) * 1.5 * delta;

            // 2. å‡åŠ›èˆ‡é‡åŠ›è¨ˆç®— (Lift & Gravity)
            const airDensity = 1.225; // ç©ºæ°£å¯†åº¦å¸¸æ•¸
            const GRAVITY = 35; // éŠæˆ²åŒ–é‡åŠ›
            // Lift = 0.5 * rho * v^2 * A * Cl (é‡å°éŠæˆ²æ‰‹æ„Ÿç°¡åŒ–)
            let liftForce = 0.5 * airDensity * Math.pow(velocity / 50, 2) * (planeStats.lift / 50);
            let verticalVelocity = liftForce - GRAVITY;
            
            // 3. é£›è¡Œæ§åˆ¶é¢ (Control Surfaces)
            let turnSpeed = (planeStats.control / 100) * delta * 2.0;
            if (keys.w) myPlaneGroup.rotateX(turnSpeed);   // Pitch Down (ä¿¯è¡)
            if (keys.s) myPlaneGroup.rotateX(-turnSpeed);  // Pitch Up (çˆ¬å‡)
            if (keys.a) myPlaneGroup.rotateZ(turnSpeed);   // Roll Left (å·¦ç¿»æ»¾)
            if (keys.d) myPlaneGroup.rotateZ(-turnSpeed);  // Roll Right (å³ç¿»æ»¾)

            // 4. ç‰©ç†æ¥µé™ç´„æŸ (Clamping) - é˜²æ­¢ç„¡é™ç¿»æ»¾
            myPlaneGroup.rotation.x = Math.max(Math.min(myPlaneGroup.rotation.x, Math.PI/2.5), -Math.PI/2.5);
            myPlaneGroup.rotation.z = Math.max(Math.min(myPlaneGroup.rotation.z, Math.PI/2), -Math.PI/2);
            
            // Auto-leveling (è‡ªå‹•å›æ­£ç³»çµ±)
            if(!keys.a && !keys.d) myPlaneGroup.rotation.z -= myPlaneGroup.rotation.z * 2 * delta;
            if(!keys.w && !keys.s) myPlaneGroup.rotation.x -= myPlaneGroup.rotation.x * 1.5 * delta;

            // 5. åŸ·è¡Œä½ç§»
            myPlaneGroup.translateZ(-velocity * delta); // å‘æ©Ÿé ­æ–¹å‘å‰é€²
            myPlaneGroup.position.y += verticalVelocity * delta; // å‡åŠ›èˆ‡é‡åŠ›äº¤äº’ä½œç”¨

            // 6. ç¢°æ’åµæ¸¬ (Collision Detection)
            // é«˜åº¦å¤ªä½æˆ–å¤ªé«˜éƒ½æœƒå¼•ç™¼ç³»çµ±ç•°å¸¸å¢œæ¯€
            if (myPlaneGroup.position.y < 3 || myPlaneGroup.position.y > 600) { 
                handleCrash(); 
                return; 
            }

            // 7. æª¢æŸ¥é»é€²åº¦åˆ¤å®š (Checkpoint Logic)
            let dist = myPlaneGroup.position.distanceTo(trackPoints[currentTargetIndex]);
            if (dist < 50) { // é€²å…¥å…‰ç’°åŠå¾‘
                rings[currentTargetIndex].material = ringMat; // æ¢å¾©èˆŠå…‰ç’°é¡è‰²
                currentTargetIndex++;
                if(currentTargetIndex >= trackPoints.length) { 
                    currentTargetIndex = 0; 
                    currentLap++; 
                    if(currentLap > 3) {
                        alert("ğŸ‰ è³½äº‹å®Œæˆï¼ä½ æ˜¯ç‹ç‰Œé£›è¡Œå“¡ï¼");
                        leaveLobby();
                        return;
                    }
                }
                rings[currentTargetIndex].material = activeRingMat; // é»äº®ä¸‹ä¸€å€‹å…‰ç’°
            }

            // æ›´æ–°å„€è¡¨æ¿ UI
            document.getElementById('speed-display').innerText = Math.round(velocity * 4);
            document.getElementById('alt-display').innerText = Math.round(myPlaneGroup.position.y * 3);
            document.getElementById('lap-display').innerText = currentLap;
            document.getElementById('chk-display').innerText = Math.round(dist);

            // 8. æ”å½±æ©Ÿå‹•æ…‹å¹³æ»‘è·Ÿéš¨ (Camera Lerp)
            const relativeOffset = cameraOffset.clone().applyMatrix4(myPlaneGroup.matrixWorld);
            camera.position.lerp(relativeOffset, 0.15); // æ•¸å­—è¶Šå°ï¼Œå»¶é²æ„Ÿèˆ‡é‡é‡æ„Ÿè¶Šé‡
            camera.lookAt(myPlaneGroup.position);
            
            updateNameTags(); 
        }

        // --- ç•«é¢åˆ‡æ›èˆ‡ç‹€æ…‹ç®¡ç† ---
        window.changeScreen = function(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            currentScreen = screenId;
            
            // éŠæˆ² HUD é¡¯ç¤ºæ§åˆ¶
            document.getElementById('hud').style.display = (screenId === 'game-ui') ? 'block' : 'none';
            document.getElementById('race-hud').style.display = (screenId === 'game-ui') ? 'block' : 'none';

            if (screenId === 'garage') {
                isGameActive = false;
                myPlaneGroup.position.set(0, 10, 0); 
                myPlaneGroup.rotation.set(0, 0, 0);
                camera.position.set(25, 15, 30); 
                camera.lookAt(myPlaneGroup.position);
            }
        };

        // --- è³½äº‹å•Ÿå‹•ç¨‹åº (Race Initialization) ---
        function startCountdownLocally() {
            changeScreen('game-ui');
            isGameActive = false; 
            
            // ç©å®¶å°±ä½
            let startPos = spawnGrid[myGridIndex % spawnGrid.length];
            myPlaneGroup.position.copy(startPos); 
            myPlaneGroup.lookAt(trackPoints[0]);
            
            // AI ç”Ÿæˆèˆ‡å°±ä½ (ä½”ç”¨ç©å®¶å¾Œæ–¹çš„ç¶²æ ¼)
            aiBots.forEach(bot => { scene.remove(bot.group); bot.label.remove(); });
            aiBots = [];
            for(let i=1; i<=3; i++) {
                // çµ¦ AI ä¸€äº›æœ‰æ°£å‹¢çš„åå­—
                let aiNames = ["Viper", "Jester", "Iceman"];
                aiBots.push(new AIBot(aiNames[i-1], myGridIndex + i));
            }

            velocity = 0; currentLap = 1; currentTargetIndex = 0;
            rings.forEach(r => r.material = ringMat); 
            rings[0].material = activeRingMat;

            // å€’æ•¸å‹•ç•«
            const countEl = document.getElementById('countdown-display');
            countEl.style.display = 'block'; 
            let c = 3; 
            countEl.innerText = c;
            
            let timer = setInterval(() => {
                c--;
                if(c > 0) countEl.innerText = c;
                else if(c === 0) {
                    countEl.innerText = "ENGAGE!";
                    countEl.style.color = "#00ffcc";
                }
                else {
                    clearInterval(timer); 
                    countEl.style.display = 'none';
                    countEl.style.color = "#fff"; // é¡è‰²é‡ç½®
                    isGameActive = true; 
                    if(isHost) set(ref(db, `rooms/${currentRoomId}/status`), 'running');
                }
            }, 1000);
        }

        // --- éŠæˆ²ä¸»è¿´åœˆ (Game Loop) ---
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            
            // åœ¨æ©Ÿåº«ä¸­åƒ…åšå±•ç¤ºæ—‹è½‰
            if (currentScreen === 'garage') { 
                myPlaneGroup.rotation.y += 0.5 * delta; 
                renderer.render(scene, camera); 
                return; 
            }
            
            // è³½äº‹é€²è¡Œä¸­
            if (isGameActive) { 
                updatePhysics(delta); 
                updateMultiplayer(); 
                aiBots.forEach(bot => bot.update(delta)); 
            }
            
            renderer.render(scene, camera);
        }

        // --- RWD éŸ¿æ‡‰å¼è¦–çª—ç¸®æ”¾ ---
        window.addEventListener('resize', () => { 
            camera.aspect = window.innerWidth/window.innerHeight; 
            camera.updateProjectionMatrix(); 
            renderer.setSize(window.innerWidth, window.innerHeight); 
        });

        // å•Ÿå‹•å¼•æ“ï¼
        animate();
    </script>
</body>
</html>
