<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>éœ“è™¹è¥¿æ´‹æ£‹ï¼šDTZ å–®æª”çµ‚æ¥µç‰ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.128.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.128.0/examples/jsm/"
        }
    }
    </script>

    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: 'Microsoft JhengHei', sans-serif; touch-action: none; color: white; }
        canvas { position: absolute; top: 0; left: 0; z-index: 0; outline: none; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .hud { pointer-events: auto; }
        #mobile-menu-btn { display: none; }
        .hud-container { position: absolute; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 15px; width: 260px; pointer-events: auto; }
        .hud-box { background: rgba(0, 0, 0, 0.85); border: 1px solid #444; border-radius: 8px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .user-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .name-text { font-weight: bold; font-size: 16px; color: #fff; display: block; }
        .elo-text { font-size: 12px; color: #888; margin-bottom: 10px; }
        .elo-text span { color: #00e5ff; font-weight: bold; }
        .custom-btn { width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: #ccc; border-radius: 6px; cursor: pointer; font-size: 13px; transition: 0.2s; }
        .custom-btn:hover { background: #333; color: #fff; border-color: #666; }
        .lobby-title { color: #aaa; font-size: 12px; letter-spacing: 1px; margin-bottom: 8px; text-transform: uppercase; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .room-status { font-size: 14px; color: #00ff00; margin-bottom: 12px; font-weight: bold; text-shadow: 0 0 5px rgba(0, 255, 0, 0.5); }
        .separator { height: 1px; background: #333; margin: 12px 0; }
        .logout-btn { background: transparent; color: #666; border: none; font-size: 12px; width: 100%; cursor: pointer; }
        #auth-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 2000; display: flex; justify-content: center; align-items: center; pointer-events: auto; backdrop-filter: blur(3px); }
        .auth-box { background: rgba(15, 15, 20, 0.9); border: 1px solid #00e5ff; padding: 30px; border-radius: 12px; width: 300px; text-align: center; box-shadow: 0 0 50px rgba(0, 229, 255, 0.3); }
        .auth-input { width: 100%; padding: 12px; margin: 8px 0; background: rgba(0,0,0,0.5); border: 1px solid #444; color: #fff; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        .auth-btn { width: 100%; padding: 12px; margin-top: 15px; background: #00e5ff; color: #000; border: none; font-weight: bold; cursor: pointer; border-radius: 6px; transition: 0.3s; }
        .guest-btn { width: 100%; padding: 10px; margin-top: 10px; background: transparent; color: #aaa; border: 1px solid #444; cursor: pointer; border-radius: 6px; }
        #status-panel { position: absolute; top: 20px; right: 20px; text-align: right; background: linear-gradient(to left, rgba(0, 255, 255, 0.1), rgba(0,0,0,0)); padding: 15px; border-right: 3px solid #00e5ff; }
        .side-panel { position: fixed; top: 0; left: 0; bottom: 0; width: 320px; background: rgba(12, 12, 18, 0.98); border-right: 1px solid #00e5ff; transform: translateX(-105%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1200; padding: 25px; overflow-y: auto; pointer-events: auto; }
        .side-panel.active { transform: translateX(0); }
        .game-btn { background: #00e5ff; color: #000; border: none; padding: 10px; margin-top: 8px; width: 100%; font-weight: bold; cursor: pointer; transition: 0.3s; border-radius: 4px; }
        .join-btn { background: #ff0055; color: #fff; }
        /* ç‰¹æ®ŠæŒ‰éˆ•æ¨£å¼ï¼šå››äººæ£‹ */
        .special-btn { background: #a333ff; color: white; margin-top: 10px; box-shadow: 0 0 10px rgba(163, 51, 255, 0.5); }
        #loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; justify-content: center; align-items: center; color: #00e5ff; font-weight: bold; z-index: 1500; }
        
        @media (max-width: 600px) {
            #mobile-menu-btn { display: flex; position: absolute; bottom: 30px; left: 20px; width: 50px; height: 50px; background: rgba(0,0,0,0.8); border: 2px solid #00e5ff; border-radius: 50%; color: #00e5ff; justify-content: center; align-items: center; z-index: 3000; pointer-events: auto; }
            .hud-container { width: 100%; position: fixed; top: auto; bottom: 0; left: 0; transform: translateY(110%); z-index: 2500; padding: 10px 20px 80px 20px; background: rgba(10, 10, 15, 0.95); border-top: 2px solid #00e5ff; }
            .hud-container.mobile-visible { transform: translateY(0); }
            #menu-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 900; }
            #menu-backdrop.active { display: block; }
        }
    </style>
</head>
<body>
<div id="loading">æ­£åœ¨è¼‰å…¥éœ“è™¹ä¸–ç•Œ...</div>

<div id="auth-modal">
    <div class="auth-box">
        <h2>DTZ CHESS</h2>
        <div id="auth-error" style="color:#ff0055; font-size:12px; margin-bottom:10px;"></div>
        <div id="email-login-form">
            <input type="email" id="email" class="auth-input" placeholder="é›»å­ä¿¡ç®±">
            <input type="password" id="password" class="auth-input" placeholder="å¯†ç¢¼">
            <div id="nickname-container" style="display:none;">
                <input type="text" id="nickname" class="auth-input" placeholder="è¨­å®šæ‚¨çš„æš±ç¨±">
            </div>
            <button id="auth-action-btn" class="auth-btn">é€²å…¥ä¸–ç•Œ</button>
        </div>
        <button id="guest-btn" class="guest-btn">è¨ªå®¢ç™»å…¥</button>
    </div>
</div>

<div id="ui" style="display:none;">
    <div id="mobile-menu-btn" onclick="toggleMenu()">â˜° é¸å–®</div>
    <div id="menu-backdrop" onclick="closeAllMenus()"></div>

    <div id="menu-panel" class="hud-container">
        <div class="hud-box profile-box">
            <div class="user-card-header">
                <img id="hud-avatar" src="" class="mini-avatar" style="width:45px; height:45px; border-radius:8px;">
                <div class="user-info">
                    <span id="user-name" class="name-text">Player</span>
                    <span id="user-rank" style="font-size:10px; color:#00e5ff;">æ–°æ‰‹</span>
                </div>
            </div>
            <div class="elo-text">æˆ°åŠ›ç©åˆ†: <span id="user-elo">0</span></div>
            <button id="btn-custom" class="custom-btn">ğŸ› ï¸ å€‹äººåŒ–è¨­å®š</button>
        </div>

        <div class="hud-box action-box">
            <div class="lobby-title">å°æˆ°å¤§å»³</div>
            <div id="room-display" class="room-status">ç‹€æ…‹ï¼šé–’ç½®ä¸­</div>
            <div id="lobby-buttons">
                <button id="btn-create" class="game-btn">å‰µå»ºæˆ¿é–“ (åŸ·ç™½)</button>
                <button id="btn-join" class="game-btn join-btn">åŠ å…¥æˆ¿é–“ (åŸ·é»‘)</button>
                
                <button id="btn-four-player" class="game-btn special-btn">å››äººæ£‹æ¨¡å¼</button>
            </div>
            <button id="btn-leave" class="game-btn" style="display:none; background:#0088ff; color:white;">é€€å‡ºæˆ¿é–“</button>
            <div class="separator"></div>
            <button id="btn-logout" class="logout-btn">ç™»å‡º</button>
        </div>
    </div>
    
    <div id="status-panel">
        <div id="turn-txt">ç­‰å¾…å°æˆ°</div>
        <div id="opponent-info" style="font-size:12px; color:#aaa;">å°æ‰‹: ---</div>
    </div>
</div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, get, update, onValue, off, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { Sky } from 'three/addons/objects/Sky.js';

    // Firebase é…ç½® (ä¿æŒåŸæ¨£)
    const firebaseConfig = {
        apiKey: "AIzaSyCxPppnUG864v3E2j1OzykzFmhLpsEJCSE",
        authDomain: "chess-1885a.firebaseapp.com",
        databaseURL: "https://chess-1885a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "chess-1885a"
    };

    let scene, camera, renderer, controls, game, currentUser, gameId, playerColor;
    let isOnline = false, isProcessing = false;
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // åˆå§‹åŒ– 3D èˆ‡éŠæˆ²
    function init() {
        game = new Chess();
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 5000);
        camera.position.set(0, 60, 100);
        
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        
        controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 15, 0);

        setupUIListeners();
        animate();
    }

    // UI äº‹ä»¶ç›£è½
    function setupUIListeners() {
        const bind = (id, fn) => { 
            const el = document.getElementById(id); 
            if(el) el.onclick = fn; 
        };

        bind('auth-action-btn', handleLogin);
        bind('btn-create', createRoom);
        bind('btn-join', () => { const id = prompt("è¼¸å…¥æˆ¿è™Ÿ"); if(id) joinRoom(id); });
        
        // [é—œéµé»] å››äººæ£‹æŒ‰éˆ•è·³è½‰
        bind('btn-four-player', () => {
            window.location.href = 'https://aarontungting-prog.github.io/DTZ-PDF-Engine/';
        });

        bind('guest-btn', () => signInAnonymously(auth));
        bind('btn-logout', () => signOut(auth));
    }

    // è™•ç†ç™»å…¥é‚è¼¯
    async function handleLogin() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        try {
            await signInWithEmailAndPassword(auth, email, pass);
        } catch (e) {
            alert("ç™»å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªå¸³å¯†");
        }
    }

    // æˆ¿é–€ç®¡ç†
    function createRoom() {
        gameId = Math.floor(1000 + Math.random() * 9000).toString();
        playerColor = 'w';
        set(ref(db, 'games/' + gameId), { fen: game.fen(), status: 'waiting' });
        document.getElementById('room-display').innerText = "æˆ¿é–“è™Ÿï¼š" + gameId;
    }

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }

    onAuthStateChanged(auth, (user) => {
        document.getElementById('loading').style.display = 'none';
        if (user) {
            currentUser = user;
            document.getElementById('auth-modal').style.display = 'none';
            document.getElementById('ui').style.display = 'block';
        } else {
            document.getElementById('auth-modal').style.display = 'flex';
            document.getElementById('ui').style.display = 'none';
        }
    });

    window.onload = init;
    window.toggleMenu = () => document.getElementById('menu-panel').classList.toggle('mobile-visible');
    window.closeAllMenus = () => document.getElementById('menu-panel').classList.remove('mobile-visible');
</script>
</body>
</html>
